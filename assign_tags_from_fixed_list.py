import json
import os
import re
from typing import List, Dict, Any
import ollama
from typing import Union
#from llama_cpp import Llama


class JsonFileTaggingAgent:
    def __init__(self, model, node_url=None, tags_list: List[str] = None, mail=False):
        self.is_local = False #isinstance(model, Llama)
        if self.is_local:
            self.model_name = 'local'
            self.model = model
        elif node_url:
            self.client = ollama.Client(host=node_url)
            self.model_name = 'from_yandex_node'
        else:
            self.client = ollama.Client()
            self.model_name = model

        self.tags_list = tags_list
        self.mail = mail
        self.processed_files = set()

    def process_directory(self, input_dir: str, output_dir: str = None):
        if output_dir and not os.path.exists(output_dir):
            os.makedirs(output_dir)

        json_files = [f for f in os.listdir(input_dir) if f.endswith('.json')]
        print(f" –ù–∞–π–¥–µ–Ω–æ {len(json_files)} JSON —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏")

        n = 0
        for i, filename in enumerate(json_files, 1):
            if filename in os.listdir(output_dir):
                n += 1
                continue
        print(f'{n} files already processed')

        for i, filename in enumerate(json_files, 1):
            print(f"\n[{i}/{len(json_files)}] –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é {filename}...")
            if filename in os.listdir(output_dir):
                continue

            input_path = os.path.join(input_dir, filename)
            output_path = os.path.join(output_dir, filename) if output_dir else input_path

            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ
            if filename in self.processed_files:
                print(f"    –ü—Ä–æ–ø—É—â–µ–Ω (—É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω)")
                continue

            try:
                result = self.tag_single_file(input_path, output_path)
                if result:
                    self.processed_files.add(filename)
                    print(f"   –£—Å–ø–µ—à–Ω–æ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω. –¢–µ–≥–∏: {result.get('tags', [])}")
            except Exception as e:
                print(f"   –û—à–∏–±–∫–∞: {e}")

    def tag_single_file(self, input_path: str, output_path: str) -> Dict[str, Any]:
        # –ó–∞–≥—Ä—É–∑–∫–∞ JSON
        with open(input_path, 'r', encoding='utf-8') as f:
            data = json.load(f)

        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        if 'transcription' in data and 'text' in data['transcription']:
            text = data['transcription']['text']
        elif 'text' in data:
            text = data['text']
        else:
            raise ValueError(f"–í —Ñ–∞–π–ª–µ {input_path} –Ω–µ –Ω–∞–π–¥–µ–Ω —Ç–µ–∫—Å—Ç –∑–≤–æ–Ω–∫–∞")

        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–≥–æ–≤ –æ—Ç LLM
        tags_result = self.get_tags_from_llm(text)

        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
        if 'tags' not in data:
            data['tags'] = {}

        data['tags']['fixed_tags'] = tags_result.get('result', [])

        data.pop('segments', None)

        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ JSON
        with open(output_path, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)

        return tags_result

    def get_tags_from_llm(self, text: str) -> Dict[str, Any]:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–≥–æ–≤ –æ—Ç LLM —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π

        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ —Ç–µ–≥–∞–º–∏
        """
        # –£—Ä–µ–∑–∞–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤ (–Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—É—Ç—å)
        truncated_text = text[:3000] + "..." if len(text) > 3000 else text

        # –°—Ç—Ä–æ–≥–∏–π –ø—Ä–æ–º–ø—Ç —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º JSON —Ñ–æ—Ä–º–∞—Ç–∞
        prompt = f"""–¢—ã ‚Äî —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤.
–ï—Å—Ç—å –∑–∞–ø–∏—Å–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –±–µ—Ä—É—Ç –≤ –∞—Ä–µ–Ω–¥—É –≥—Ä—è–∑–µ–∑–∞—â–∏—Ç–Ω—ã–µ –∫–æ–≤—Ä—ã –∏ –ø–æ–ª—É—á–∞—é—Ç —É—Å–ª—É–≥–∏ –ø–æ –∏—Ö –¥–æ—Å—Ç–∞–≤–∫–µ (–∑–∞–º–µ–Ω–µ) –∏ —á–∏—Å—Ç–∫–µ.

–í–æ—Ç —Ç–µ–∫—Å—Ç –æ–¥–Ω–æ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞:
{truncated_text}

–¢–í–û–ï –ó–ê–î–ê–ù–ò–ï: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ –ø—Ä–∏—Å–≤–æ–π –µ–º—É –æ—Ç 1 –¥–æ 3 —Ç–µ–≥–æ–≤, –Ω–∞–∏–±–æ–ª–µ–µ —Ö–æ—Ä–æ—à–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É—é—â–∏—Ö –ø—Ä–∏—á–∏–Ω—ã –æ–±—Ä–∞—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞.
–ù–∞–ø—Ä–∏–º–µ—Ä, –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–≥–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –µ–≥–æ –∑–∞—è–≤–∫—É –æ —Ç–æ–º, —á—Ç–æ –µ–º—É –Ω–µ –¥–æ—Å—Ç–∞–≤–∏–ª–∏ –≤–æ–≤—Ä–µ–º—è –∫–æ–≤–µ—Ä. –¢–æ–≥–¥–∞ –±—É–¥–µ—Ç –¥–≤–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–µ–≥–∞: –ø—Ä–æ –¥–æ–ª–≥–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –∏ –ø—Ä–æ –Ω–µ–¥–æ—Å—Ç–∞–≤–∫—É (–Ω–µ—Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω—É—é –∑–∞–º–µ–Ω—É).
–õ–∏–±–æ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –ò –ø—Ä–∏ —ç—Ç–æ–º –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –∫–æ–≤—Ä–æ–≤, —á–µ–º –±—ã–ª–æ —É –Ω–µ–≥–æ —Ä–∞–Ω—å—à–µ. –¢–æ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–µ–≥ –ø—Ä–æ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥ –∏ —Ç–µ–≥ –ø—Ä–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–≤—Ä–æ–≤. –ò —Ç–∞–∫ –¥–∞–ª–µ–µ.

–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≤—ã—Ä–∞–∂–∞–µ—Ç –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ —Ü–µ–Ω–∞–º–∏ –∏–ª–∏ –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ, –ø–æ—á–µ–º—É —Ü–µ–Ω—ã –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ –≤—ã—Ä–æ—Å–ª–∏, - –≤—ã–±–∏—Ä–∞–π —Ç–µ–≥ –∫–ª–∏–µ–Ω—Ç_–Ω–µ–¥–æ–≤–æ–ª–µ–Ω_—Ü–µ–Ω–∞–º–∏. –ù–æ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–º —Ä–æ—Å—Ç–µ —Ü–µ–Ω, –∏–ª–∏ —É—Ç–æ—á–Ω—è–µ—Ç, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è, –Ω–µ –≤—ã—Ä–∞–∂–∞—è –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏—è –∏–ª–∏ –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–∞, - —Ç–æ –≤—ã–±–∏—Ä–∞–π —Ç–µ–≥, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å —É—Ç–æ—á–Ω–µ–Ω–∏–µ–º –¥–µ—Ç–∞–ª–µ–π. –°–∞–º —Ñ–∞–∫—Ç —Ä–æ—Å—Ç–∞ —Ü–µ–Ω –≤ —Å–≤—è–∑–∏ —Å –∏–Ω—Ñ–ª—è—Ü–∏–µ–π - –Ω–æ—Ä–º–∞–ª–µ–Ω.

–í—ã–±–∏—Ä–∞–π —Ç–µ–≥ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è_–∏–ª–∏_—É—Ç–æ—á–Ω–µ–Ω–∏–µ_–¥–µ—Ç–∞–ª–µ–π, –µ—Å–ª–∏ –Ω–µ—Ç –Ω–∏–∫–∞–∫–æ–π –¥—Ä—É–≥–æ–π –ø—Ä–∏—á–∏–Ω—ã –æ–±—Ä–∞—â–µ–Ω–∏—è!

–¢–µ–≥–∏ –º–æ–∂–Ω–æ –±—Ä–∞—Ç—å —Å—Ç—Ä–æ–≥–æ –∏–∑ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞:
{', '.join(self.tags_list)}
–ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –¥—Ä—É–≥–∏–µ —Ç–µ–≥–∏!

–í–ï–†–ù–ò –û–¢–í–ï–¢ –¢–û–õ–¨–ö–û –í –§–û–†–ú–ê–¢–ï JSON:
{{
  "result": ["tag1", "tag2"],
}}
–ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —è—Å–Ω–æ–π –ø—Ä–∏—á–∏–Ω—ã –æ–±—Ä–∞—â–µ–Ω–∏—è - –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
"""
        
        # –°—Ç—Ä–æ–≥–∏–π –ø—Ä–æ–º–ø—Ç —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º JSON —Ñ–æ—Ä–º–∞—Ç–∞
        prompt_mail = f"""–¢—ã ‚Äî —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–∏—Å–µ–º —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã.
–ï—Å—Ç—å –µ–º–µ–π–ª —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±–µ—Ä—É—Ç –≤ –∞—Ä–µ–Ω–¥—É –≥—Ä—è–∑–µ–∑–∞—â–∏—Ç–Ω—ã–µ –∫–æ–≤—Ä—ã –∏ –ø–æ–ª—É—á–∞—é—Ç —É—Å–ª—É–≥–∏ –ø–æ –∏—Ö –¥–æ—Å—Ç–∞–≤–∫–µ (–∑–∞–º–µ–Ω–µ) –∏ —á–∏—Å—Ç–∫–µ.

–í–æ—Ç –æ–¥–∏–Ω —Ç–µ–∫—Å—Ç:
{truncated_text}

–¢–í–û–ï –ó–ê–î–ê–ù–ò–ï: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –∏ –ø—Ä–∏—Å–≤–æ–π –µ–º—É –æ—Ç 1 –¥–æ 3 —Ç–µ–≥–æ–≤, –Ω–∞–∏–±–æ–ª–µ–µ —Ö–æ—Ä–æ—à–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É—é—â–∏—Ö –ø—Ä–∏—á–∏–Ω—ã –æ–±—Ä–∞—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞.
–ù–∞–ø—Ä–∏–º–µ—Ä, –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–≥–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –µ–≥–æ –∑–∞—è–≤–∫—É –æ —Ç–æ–º, —á—Ç–æ –µ–º—É –Ω–µ –¥–æ—Å—Ç–∞–≤–∏–ª–∏ –≤–æ–≤—Ä–µ–º—è –∫–æ–≤–µ—Ä. –¢–æ–≥–¥–∞ –±—É–¥–µ—Ç –¥–≤–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–µ–≥–∞: –ø—Ä–æ –¥–æ–ª–≥–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –∏ –ø—Ä–æ –Ω–µ–¥–æ—Å—Ç–∞–≤–∫—É (–Ω–µ—Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω—É—é –∑–∞–º–µ–Ω—É).
–õ–∏–±–æ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å —É—Å–ª—É–≥–∏ –ò –ø—Ä–∏ —ç—Ç–æ–º –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –∫–æ–≤—Ä–æ–≤, —á–µ–º –±—ã–ª–æ —É –Ω–µ–≥–æ —Ä–∞–Ω—å—à–µ. –¢–æ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–µ–≥ –ø—Ä–æ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥ –∏ —Ç–µ–≥ –ø—Ä–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–≤—Ä–æ–≤. –ò —Ç–∞–∫ –¥–∞–ª–µ–µ.

–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≤—ã—Ä–∞–∂–∞–µ—Ç –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ —Ü–µ–Ω–∞–º–∏ –∏–ª–∏ –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ, –ø–æ—á–µ–º—É —Ü–µ–Ω—ã –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ –≤—ã—Ä–æ—Å–ª–∏, - –≤—ã–±–∏—Ä–∞–π —Ç–µ–≥ –∫–ª–∏–µ–Ω—Ç_–Ω–µ–¥–æ–≤–æ–ª–µ–Ω_—Ü–µ–Ω–∞–º–∏. –ù–æ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–º —Ä–æ—Å—Ç–µ —Ü–µ–Ω, –∏–ª–∏ —É—Ç–æ—á–Ω—è–µ—Ç, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è, –Ω–µ –≤—ã—Ä–∞–∂–∞—è –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏—è –∏–ª–∏ –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–∞, - —Ç–æ –≤—ã–±–∏—Ä–∞–π —Ç–µ–≥, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å —É—Ç–æ—á–Ω–µ–Ω–∏–µ–º –¥–µ—Ç–∞–ª–µ–π. –°–∞–º —Ñ–∞–∫—Ç —Ä–æ—Å—Ç–∞ —Ü–µ–Ω –≤ —Å–≤—è–∑–∏ —Å –∏–Ω—Ñ–ª—è—Ü–∏–µ–π - –Ω–æ—Ä–º–∞–ª–µ–Ω.

–í—ã–±–∏—Ä–∞–π —Ç–µ–≥ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è_–∏–ª–∏_—É—Ç–æ—á–Ω–µ–Ω–∏–µ_–¥–µ—Ç–∞–ª–µ–π, –µ—Å–ª–∏ –Ω–µ—Ç –Ω–∏–∫–∞–∫–æ–π –¥—Ä—É–≥–æ–π –ø—Ä–∏—á–∏–Ω—ã –æ–±—Ä–∞—â–µ–Ω–∏—è!

–¢–µ–≥–∏ –º–æ–∂–Ω–æ –±—Ä–∞—Ç—å —Å—Ç—Ä–æ–≥–æ –∏–∑ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞:
{', '.join(self.tags_list)}
–ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –¥—Ä—É–≥–∏–µ —Ç–µ–≥–∏!

–í–ï–†–ù–ò –û–¢–í–ï–¢ –¢–û–õ–¨–ö–û –í –§–û–†–ú–ê–¢–ï JSON:
{{
  "result": ["tag1", "tag2"],
}}
–ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —è—Å–Ω–æ–π –ø—Ä–∏—á–∏–Ω—ã –æ–±—Ä–∞—â–µ–Ω–∏—è - –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
"""

        empty_response = {
                "result": [],
                "additional_tags": [],
                "reasoning": "–û—à–∏–±–∫–∞"
            }
        
        try:
            if len(truncated_text) < 30:
                print('Text is too short')
                return empty_response
            if self.is_local:
                response = self.model(prompt_mail if self.mail else prompt,
                                      format='json',
                                      temperature=0.3,
                                      top_p=0.9)
            else:
                print('Getting response...')
                response = self.client.generate(
                    model=self.model_name,
                    prompt=prompt,
                    format="json",
                    options={
                        'temperature': 0.3,
                        'top_p': 0.9
                    }
                )

            response_text = response['response']
            print(response_text)

            json_match = re.search(r'\{.*\}', response_text, re.DOTALL)
            if json_match:
                result = json.loads(json_match.group())

                valid_selected = []
                for tag in result.get('result', []):
                    if tag in self.tags_list:
                        valid_selected.append(tag)
                    else:
                        print(f"   ‚ö†Ô∏è  –ú–æ–¥–µ–ª—å –ø—Ä–∏–¥—É–º–∞–ª–∞ —Ç–µ–≥ '{tag}', –∏–≥–Ω–æ—Ä–∏—Ä—É—é")

                result['result'] = valid_selected

                return result
            else:
                raise ValueError("LLM –Ω–µ –≤–µ—Ä–Ω—É–ª–∞ JSON")

        except Exception as e:
            print(f"   ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ LLM: {e}")
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            return empty_response

    def validate_tags_consistency(self, input_dir: str, sample_size: int = 20):
        print("\n" + "=" * 60)
        print(" –ü–†–û–í–ï–†–ö–ê –ö–û–ù–°–ò–°–¢–ï–ù–¢–ù–û–°–¢–ò –¢–ï–ì–ò–†–û–í–ê–ù–ò–Ø")
        print("=" * 60)

        json_files = [f for f in os.listdir(input_dir) if f.endswith('.json')]
        sample_files = json_files[:min(sample_size, len(json_files))]

        tag_counts = {}
        additional_counts = {}

        for filename in sample_files:
            with open(os.path.join(input_dir, filename), 'r', encoding='utf-8') as f:
                data = json.load(f)

            if 'tags' in data and 'fixed' in data['tags']:
                for tag in data['tags']['fixed']:
                    tag_counts[tag] = tag_counts.get(tag, 0) + 1

        print("\n –°–¢–ê–¢–ò–°–¢–ò–ö–ê –¢–ï–ì–û–í (–≤—ã–±–æ—Ä–∫–∞):")
        for tag, count in sorted(tag_counts.items(), key=lambda x: x[1], reverse=True):
            print(f"   {tag}: {count}")

        if additional_counts:
            print("\nüí° –ü–†–ï–î–õ–û–ñ–ï–ù–ù–´–ï –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –¢–ï–ì–ò:")
            for tag, count in sorted(additional_counts.items(), key=lambda x: x[1], reverse=True):
                print(f"   '{tag}': {count}")

        print(f"\n‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {len(sample_files)}")
        print(f"‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–µ–≥–æ–≤: {len(tag_counts)}")


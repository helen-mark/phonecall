import threading
import queue
from datetime import datetime
import json
from mcp_orchestrator import JSONCallAnalyticsMCP, Dict

class AnalyticsChatBot:
    """–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —á–∞—Ç-–±–æ—Ç –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ"""

    def __init__(self, json_directory: str):
        self.system = JSONCallAnalyticsMCP(json_directory)
        self.context = {}  # –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞
        self.message_queue = queue.Queue()
        self.running = False

    def start(self):
        """–ó–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞"""
        self.running = True

        print("""
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë      ü§ñ –ê–ù–ê–õ–ò–¢–ò–ö –ó–í–û–ù–ö–û–í 1.0          ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        """)

        self._print_welcome()

        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        worker_thread = threading.Thread(target=self._process_queue, daemon=True)
        worker_thread.start()

        # –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –≤–≤–æ–¥–∞
        while self.running:
            try:
                user_input = input("\nüë§ –í—ã: ").strip()

                if not user_input:
                    continue

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—ã
                if self._handle_command(user_input):
                    continue

                # –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
                self.message_queue.put({
                    'type': 'query',
                    'text': user_input,
                    'timestamp': datetime.now()
                })

                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏
                print("ü§î –î—É–º–∞—é...", end='', flush=True)

            except KeyboardInterrupt:
                print("\n\nüëã –ó–∞–≤–µ—Ä—à–∞—é —Ä–∞–±–æ—Ç—É...")
                self.running = False
                break

    def _process_queue(self):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –æ—á–µ—Ä–µ–¥–∏"""
        while self.running:
            try:
                message = self.message_queue.get(timeout=1)

                if message['type'] == 'query':
                    # –û—á–∏—â–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                    print("\r" + " " * 20 + "\r", end='', flush=True)

                    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å
                    result = self.system.process_query(message['text'])

                    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
                    self._update_context(message['text'], result)

                    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏ –≤—ã–≤–æ–¥–∏–º –æ—Ç–≤–µ—Ç
                    self._print_response(result)

            except queue.Empty:
                continue
            except Exception as e:
                print(f"\r‚ùå –û—à–∏–±–∫–∞: {e}")

    def _handle_command(self, command: str) -> bool:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã"""
        cmd = command.lower()

        if cmd in ['/–≤—ã—Ö–æ–¥', '/exit', '–≤—ã—Ö–æ–¥', 'exit']:
            self.running = False
            return True

        elif cmd in ['/–ø–æ–º–æ—â—å', '/help', '–ø–æ–º–æ—â—å', 'help']:
            self._show_bot_help()
            return True

        elif cmd in ['/–∫–æ–Ω—Ç–µ–∫—Å—Ç', '/context']:
            self._show_context()
            return True

        elif cmd in ['/–ø—Ä–∏–º–µ—Ä—ã', '/examples']:
            self._show_examples()
            return True

        elif cmd in ['/—Å–±—Ä–æ—Å', '/reset']:
            self.context = {}
            print("üßπ –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–±—Ä–æ—à–µ–Ω")
            return True

        elif cmd.startswith('/–∏—Å—Ç–æ—Ä–∏—è'):
            self._show_query_history()
            return True

        return False

    def _print_welcome(self):
        """–ü–µ—á–∞—Ç–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
        welcome = """
–Ø - –≤–∞—à –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤.
–Ø –º–æ–≥—É –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å 2000+ –∑–≤–æ–Ω–∫–æ–≤ –≤ –º–µ—Å—è—Ü –∏ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã.

üìä –ß–¢–û –Ø –£–ú–ï–Æ:
‚Ä¢ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–Ω–¥—ã –ø–æ —Ç–µ–≥–∞–º
‚Ä¢ –°—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã
‚Ä¢ –ù–∞—Ö–æ–¥–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –≤ —Å–µ—Ä–≤–∏—Å–µ
‚Ä¢ –î–∞–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

üí° –ü–†–ò–ú–ï–†–´ –í–û–ü–†–û–°–û–í:
‚Ä¢ "–ö–∞–∫–∏–µ –≥–ª–∞–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —É –∫–ª–∏–µ–Ω—Ç–æ–≤?"
‚Ä¢ "–°—Ä–∞–≤–Ω–∏ –∂–∞–ª–æ–±—ã –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ –∏ –¥–æ—Å—Ç–∞–≤–∫—É"
‚Ä¢ "–ö–∞–∫ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å —Å–∏—Ç—É–∞—Ü–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–≤–∞—Ä—Ç–∞–ª?"
‚Ä¢ "–ß—Ç–æ –≥–æ–≤–æ—Ä—è—Ç –∫–ª–∏–µ–Ω—Ç—ã –æ –Ω–∞—à–∏—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–∞—Ö?"

–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ /–ø–æ–º–æ—â—å –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.
        """
        print(welcome)

    def _show_bot_help(self):
        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø—Ä–∞–≤–∫—É –ø–æ –∫–æ–º–∞–Ω–¥–∞–º"""
        help_text = """
üìñ –ö–û–ú–ê–ù–î–´ –ë–û–¢–ê:

/–ø–æ–º–æ—â—å     - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞
/–≤—ã—Ö–æ–¥      - –≤—ã–π—Ç–∏ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã
/–ø—Ä–∏–º–µ—Ä—ã    - –ø—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤
/–∫–æ–Ω—Ç–µ–∫—Å—Ç   - –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
/—Å–±—Ä–æ—Å      - —Å–±—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞
/–∏—Å—Ç–æ—Ä–∏—è    - –ø–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤

üìà –¢–ò–ü–û–í–´–ï –ó–ê–ü–†–û–°–´:
‚Ä¢ "–∂–∞–ª–æ–±—ã –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü"
‚Ä¢ "–¥–∏–Ω–∞–º–∏–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π –ø–æ –Ω–µ–¥–µ–ª—è–º"
‚Ä¢ "—Ç–æ–ø-5 –ø—Ä–æ–±–ª–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤"
‚Ä¢ "—Å—Ä–∞–≤–Ω–∏ —è–Ω–≤–∞—Ä—å –∏ —Ñ–µ–≤—Ä–∞–ª—å –ø–æ –∂–∞–ª–æ–±–∞–º"
‚Ä¢ "–∫–∞–∫ —É–ª—É—á—à–∏—Ç—å —Å–µ—Ä–≤–∏—Å –¥–æ—Å—Ç–∞–≤–∫–∏"

üéØ –°–û–í–ï–¢: –£–∫–∞–∑—ã–≤–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã –∏ —Ç–µ–≥–∏ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.
        """
        print(help_text)

    def _update_context(self, query: str, result: Dict):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞"""
        if 'context' not in self.context:
            self.context['context'] = []

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –∑–∞–ø—Ä–æ—Å–∞ —Å –æ—Ç–≤–µ—Ç–∞–º–∏
        self.context['context'].append({
            'query': query,
            'answer': result.get('answer', ''),
            'timestamp': datetime.now().isoformat(),
            'tags': result.get('analysis_plan', {}).get('target_tags', [])
        })

        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        if len(self.context['context']) > 3:
            self.context['context'] = self.context['context'][-3:]

    def _print_response(self, result: Dict):
        """–ö—Ä–∞—Å–∏–≤–æ –≤—ã–≤–æ–¥–∏—Ç –æ—Ç–≤–µ—Ç"""
        answer = result.get('answer', '')

        # –†–∞–∑–¥–µ–ª—è–µ–º –æ—Ç–≤–µ—Ç –Ω–∞ –∞–±–∑–∞—Ü—ã
        paragraphs = answer.split('\n\n')

        print("\n" + "=" * 60)
        print("ü§ñ –ê–ù–ê–õ–ò–¢–ò–ö:")
        print("-" * 40)

        for para in paragraphs:
            if para.strip():
                # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø –¥–ª—è –∞–±–∑–∞—Ü–µ–≤
                print(f"  {para.strip()}")

        print("-" * 40)

        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        if 'raw_results' in result:
            raw = result['raw_results']
            if 'count_by_tag' in raw:
                counts = raw['count_by_tag']
                if counts:
                    print("üìä –¶–ò–§–†–´:")
                    for tag, count in counts.items():
                        print(f"  ‚Ä¢ {tag}: {count}")

        # –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏
        print("\nüí≠ –ß–¢–û –î–ê–õ–¨–®–ï?")
        print("  ‚Ä¢ –ó–∞–¥–∞–π—Ç–µ —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å")
        print("  ‚Ä¢ –°–ø—Ä–æ—Å–∏—Ç–µ –æ –¥—Ä—É–≥–æ–º –ø–µ—Ä–∏–æ–¥–µ")
        print("  ‚Ä¢ –°—Ä–∞–≤–Ω–∏—Ç–µ —Å –¥—Ä—É–≥–∏–º–∏ —Ç–µ–≥–∞–º–∏")
        print("  ‚Ä¢ –ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å")

    def _show_context(self):
        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç"""
        if not self.context.get('context'):
            print("üìù –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞ –ø—É—Å—Ç")
            return

        print("\nüìã –ö–û–ù–¢–ï–ö–°–¢ –î–ò–ê–õ–û–ì–ê:")
        print("-" * 40)

        for i, item in enumerate(self.context['context'], 1):
            time_str = datetime.fromisoformat(item['timestamp']).strftime('%H:%M')
            print(f"{i}. [{time_str}] –í–æ–ø—Ä–æ—Å: {item['query'][:50]}...")
            if item.get('tags'):
                print(f"   üè∑Ô∏è –¢–µ–≥–∏: {', '.join(item['tags'])}")
            print()

    def _show_examples(self):
        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤"""
        examples = """
üéØ –ü–†–ò–ú–ï–†–´ –ó–ê–ü–†–û–°–û–í –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê:

1. –ö–û–õ–ò–ß–ï–°–¢–í–ï–ù–ù–´–ô –ê–ù–ê–õ–ò–ó:
   ‚Ä¢ "–°–∫–æ–ª—å–∫–æ –∂–∞–ª–æ–± –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É –≤ –æ–∫—Ç—è–±—Ä–µ?"
   ‚Ä¢ "–°–∫–æ–ª—å–∫–æ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–µ–π –ø–æ–ª—É—á–∏–ª–∏ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ?"
   ‚Ä¢ "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞—â–µ–Ω–∏–π –ø–æ —Å–º–µ–Ω–µ —à—Ç–æ—Ä"

2. –¢–†–ï–ù–î–´ –ò –î–ò–ù–ê–ú–ò–ö–ê:
   ‚Ä¢ "–ö–∞–∫ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∂–∞–ª–æ–± –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞?"
   ‚Ä¢ "–î–∏–Ω–∞–º–∏–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ –æ–ø–ª–∞—Ç–µ –ø–æ –Ω–µ–¥–µ–ª—è–º"
   ‚Ä¢ "–°–µ–∑–æ–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã –æ–±—Ä–∞—â–µ–Ω–∏–π"

3. –°–†–ê–í–ù–ï–ù–ò–ï:
   ‚Ä¢ "–ß—Ç–æ —á–∞—â–µ: –∂–∞–ª–æ–±—ã –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ –∏–ª–∏ –¥–æ—Å—Ç–∞–≤–∫—É?"
   ‚Ä¢ "–°—Ä–∞–≤–Ω–∏ —è–Ω–≤–∞—Ä—å –∏ –º–∞—Ä—Ç –ø–æ –≤—Å–µ–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º"
   ‚Ä¢ "–ö–∞–∫–∏–µ —Ç–µ–º—ã —Å—Ç–∞–ª–∏ —á–∞—â–µ/—Ä–µ–∂–µ"

4. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
   ‚Ä¢ "–ì–¥–µ –Ω–∞—à–∏ —Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞ –≤ —Å–µ—Ä–≤–∏—Å–µ?"
   ‚Ä¢ "–ß—Ç–æ –Ω—É–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å?"
   ‚Ä¢ "–ö–∞–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Ç—Ä–µ–±—É—é—Ç —Å—Ä–æ—á–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è?"

5. –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó:
   ‚Ä¢ "–ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –∂–∞–ª–æ–±–∞–º –∑–∞ –∫–≤–∞—Ä—Ç–∞–ª"
   ‚Ä¢ "–ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤"
   ‚Ä¢ "–ö–æ—Ä–Ω–µ–≤—ã–µ –ø—Ä–∏—á–∏–Ω—ã —Å–∞–º—ã—Ö —á–∞—Å—Ç—ã—Ö –ø—Ä–æ–±–ª–µ–º"
        """
        print(examples)

    def _show_query_history(self):
        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)"""
        # –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤ —Ñ–∞–π–ª–µ/–ë–î
        print("\nüïê –ò–°–¢–û–†–ò–Ø –ó–ê–ü–†–û–°–û–í:")
        print("(–î–ª—è –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)")
        print("-" * 40)

        # –ò—â–µ–º —Ñ–∞–π–ª—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
        import glob
        result_files = glob.glob("results/query_*.json")

        if result_files:
            for i, filepath in enumerate(sorted(result_files[-5:]), 1):
                try:
                    with open(filepath, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                    query = data.get('query', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
                    time_str = data.get('timestamp', '').split('T')[0]
                    print(f"{i}. [{time_str}] {query[:60]}...")
                except:
                    pass
        else:
            print("–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞ –ø—É—Å—Ç–∞")